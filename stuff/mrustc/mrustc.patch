From 7a0d6874e87fb3ae673b855822b48cafdbe2879f Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Sun, 5 Jul 2020 18:01:36 +0300
Subject: [PATCH] ataraxia

Made by Ataraxia Linux with love

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 Makefile                     |  7 +++++--
 minicargo.mk                 |  2 +-
 run_rustc/Makefile           |  2 +-
 rust-version                 |  2 +-
 src/trans/target.cpp         | 22 +++++++++++-----------
 tools/common/target_detect.h |  8 ++++----
 tools/minicargo/manifest.cpp |  2 +-
 7 files changed, 24 insertions(+), 21 deletions(-)

diff --git a/Makefile b/Makefile
index 97c65007..352c3a15 100644
--- a/Makefile
+++ b/Makefile
@@ -208,9 +208,12 @@ $(RUSTC_SRC_TARBALL): $(RUSTC_SRC_DES)
 	@echo [CURL] $@
 	@rm -f $@
 	@curl -sS https://static.rust-lang.org/dist/$@ -o $@
-$(RUSTC_SRC_DL): $(RUSTC_SRC_TARBALL) rustc-$(RUSTC_VERSION)-src.patch
+$(RUSTC_SRC_DL): $(RUSTC_SRC_TARBALL) rustc.patch
 	tar -xf $(RUSTC_SRC_TARBALL)
-	cd $(RUSTCSRC) && patch -p0 < ../rustc-$(RUSTC_VERSION)-src.patch;
+	cd $(RUSTCSRC) && patch -p1 < ../rustc.patch;
+	cd $(RUSTCSRC) && patch -p1 < ../musl.patch;
+	cd $(RUSTCSRC) && patch -p1 < ../hardening.patch;
+	cd $(RUSTCSRC) && patch -p1 < ../libressl.patch;
 	cat $(RUSTC_SRC_DES) > $(RUSTC_SRC_DL)
 endif
 
diff --git a/minicargo.mk b/minicargo.mk
index 63869f29..0d910f89 100644
--- a/minicargo.mk
+++ b/minicargo.mk
@@ -31,7 +31,7 @@ OUTDIR := output$(OUTDIR_SUF)/
 MRUSTC ?= bin/mrustc$(EXESUF)
 MINICARGO := bin/minicargo$(EXESUF)
 RUSTC_OUT_BIN := rustc
-ifeq ($(RUSTC_VERSION),1.29.0)
+ifeq ($(RUSTC_VERSION),1.44.1)
   RUSTC_OUT_BIN := rustc_binary
 endif
 ifeq ($(RUSTC_CHANNEL),nightly)
diff --git a/run_rustc/Makefile b/run_rustc/Makefile
index 4dcbf1f4..cf07175e 100644
--- a/run_rustc/Makefile
+++ b/run_rustc/Makefile
@@ -9,7 +9,7 @@ else
 OUTDIR_SUF ?= -$(RUSTC_VERSION)
 endif
 
-RUSTC_TARGET := x86_64-unknown-linux-gnu
+RUSTC_TARGET := x86_64-unknown-linux-musl
 
 OUTDIR := output$(OUTDIR_SUF)/
 PREFIX := $(OUTDIR)prefix/
diff --git a/rust-version b/rust-version
index 5e57fb89..d724e439 100644
--- a/rust-version
+++ b/rust-version
@@ -1 +1 @@
-1.29.0
+1.44.1
diff --git a/src/trans/target.cpp b/src/trans/target.cpp
index f36bbfc1..06bbecce 100644
--- a/src/trans/target.cpp
+++ b/src/trans/target.cpp
@@ -369,38 +369,38 @@ namespace
         {
             return load_spec_from_file(target_name);
         }
-        else if(target_name == "i586-linux-gnu")
+        else if(target_name == "i686-linux-musl")
         {
             return TargetSpec {
-                "unix", "linux", "gnu", {CodegenMode::Gnu11, true, "i586-linux-gnu", BACKEND_C_OPTS_GNU},
+                "unix", "linux", "musl", {CodegenMode::Gnu11, true, "i686-linux-musl", BACKEND_C_OPTS_GNU},
                 ARCH_X86
                 };
         }
-        else if(target_name == "x86_64-linux-gnu")
+        else if(target_name == "x86_64-linux-musl")
         {
             return TargetSpec {
-                "unix", "linux", "gnu", {CodegenMode::Gnu11, false, "x86_64-linux-gnu", BACKEND_C_OPTS_GNU},
+                "unix", "linux", "musl", {CodegenMode::Gnu11, false, "x86_64-linux-musl", BACKEND_C_OPTS_GNU},
                 ARCH_X86_64
                 };
         }
-        else if(target_name == "arm-linux-gnu")
+        else if(target_name == "arm-linux-musl")
         {
             return TargetSpec {
-                "unix", "linux", "gnu", {CodegenMode::Gnu11, true, "arm-elf-eabi", BACKEND_C_OPTS_GNU},
+                "unix", "linux", "musl", {CodegenMode::Gnu11, true, "arm-elf-eabi", BACKEND_C_OPTS_GNU},
                 ARCH_ARM32
                 };
         }
-        else if(target_name == "aarch64-linux-gnu")
+        else if(target_name == "aarch64-linux-musl")
         {
             return TargetSpec {
-                "unix", "linux", "gnu", {CodegenMode::Gnu11, false, "aarch64-linux-gnu", BACKEND_C_OPTS_GNU},
+                "unix", "linux", "musl", {CodegenMode::Gnu11, false, "aarch64-linux-musl", BACKEND_C_OPTS_GNU},
                 ARCH_ARM64
                 };
         }
-        else if(target_name == "m68k-linux-gnu")
+        else if(target_name == "m68k-linux-musl")
         {
             return TargetSpec {
-                "unix", "linux", "gnu", {CodegenMode::Gnu11, true, "m68k-linux-gnu", BACKEND_C_OPTS_GNU},
+                "unix", "linux", "musl", {CodegenMode::Gnu11, true, "m68k-linux-musl", BACKEND_C_OPTS_GNU},
                 ARCH_M68K
                 };
         }
@@ -557,7 +557,7 @@ void Target_SetCfg(const ::std::string& target_name)
     if( g_target.m_os_name == "linux" )
     {
         Cfg_SetFlag("linux");
-        Cfg_SetValue("target_vendor", "gnu");
+        Cfg_SetValue("target_vendor", "unknown");
     }
 
     if( g_target.m_os_name == "freebsd" )
diff --git a/tools/common/target_detect.h b/tools/common/target_detect.h
index dda4bc31..6b6328f0 100644
--- a/tools/common/target_detect.h
+++ b/tools/common/target_detect.h
@@ -17,13 +17,13 @@
 // - Linux
 #elif defined(__linux__)
 # if defined(__amd64__)
-#  define DEFAULT_TARGET_NAME "x86_64-linux-gnu"
+#  define DEFAULT_TARGET_NAME "x86_64-linux-musl"
 # elif defined(__aarch64__)
-#  define DEFAULT_TARGET_NAME "aarch64-linux-gnu"
+#  define DEFAULT_TARGET_NAME "aarch64-linux-musl"
 # elif defined(__arm__)
-#  define DEFAULT_TARGET_NAME "arm-linux-gnu"
+#  define DEFAULT_TARGET_NAME "arm-linux-musl"
 # elif defined(__i386__)
-#  define DEFAULT_TARGET_NAME "i586-linux-gnu"
+#  define DEFAULT_TARGET_NAME "i686-linux-musl"
 # elif defined(__m68k__)
 #  define DEFAULT_TARGET_NAME "m68k-linux-gnu"
 # else
diff --git a/tools/minicargo/manifest.cpp b/tools/minicargo/manifest.cpp
index 569b6696..d2fb3aa4 100644
--- a/tools/minicargo/manifest.cpp
+++ b/tools/minicargo/manifest.cpp
@@ -21,7 +21,7 @@
 #elif defined(__NetBSD__)
 # define TARGET_NAME "x86_64-unknown-netbsd"
 #else
-# define TARGET_NAME "x86_64-unknown-linux-gnu"
+# define TARGET_NAME "x86_64-unknown-linux-musl"
 #endif
 
 static ::std::vector<::std::shared_ptr<PackageManifest>>    g_loaded_manifests;
-- 
2.27.0

From 57d8eb6979987223c8729623831f03522a09c3a7 Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Sun, 5 Jul 2020 18:15:55 +0300
Subject: [PATCH] llvm infrastructure

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 minicargo.mk | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/minicargo.mk b/minicargo.mk
index 0d910f89..af9db145 100644
--- a/minicargo.mk
+++ b/minicargo.mk
@@ -125,7 +125,7 @@ LLVM_CMAKE_OPTS += CMAKE_BUILD_TYPE=RelWithDebInfo
 
 $(LLVM_CONFIG): $(RUSTCSRC)build/Makefile
 	$Vcd $(RUSTCSRC)build && $(MAKE)
-$(RUSTCSRC)build/Makefile: $(RUSTCSRC)src/llvm/CMakeLists.txt
+$(RUSTCSRC)build/Makefile: $(RUSTCSRC)src/llvm-project/llvm/CMakeLists.txt
 	@mkdir -p $(RUSTCSRC)build
 	$Vcd $(RUSTCSRC)build && cmake $(addprefix -D , $(LLVM_CMAKE_OPTS)) ../src/llvm
 
-- 
2.27.0

